#!/usr/bin/env node
"use strict";var I=Object.create;var R=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames;var A=Object.getPrototypeOf,G=Object.prototype.hasOwnProperty;var T=(o,n,i,a)=>{if(n&&typeof n=="object"||typeof n=="function")for(let m of q(n))!G.call(o,m)&&m!==i&&R(o,m,{get:()=>n[m],enumerable:!(a=J(n,m))||a.enumerable});return o};var x=(o,n,i)=>(i=o!=null?I(A(o)):{},T(n||!o||!o.__esModule?R(i,"default",{value:o,enumerable:!0}):i,o));var k=require("@prisma/generator-helper");var l=x(require("path")),C=x(require("child_process")),p=x(require("fs")),N=x(require("os")),L=require("url"),j=x(require("dotenv"));j.config();function z(o,n){let{tableOnly:i=!1,ignoreEnums:a=!1,includeRelationFromFields:m=!1,disableEmoji:g=!1}=n??{},$="erDiagram",d=o.models.concat(o.types),S=i||a?"":o.enums.map(s=>`
        ${s.dbName||s.name} {
            ${s.values.map(t=>`${t.name||t.dbName} ${t.dbName||t.name}`).join(`
`)}
        }
    `).join(`

`),E=g?'"PK"':'"\u{1F5DD}\uFE0F"',y=g?'"nullable"':'"\u2753"',w=d.map(s=>`  "${s.dbName||s.name}" {
${i?"":s.fields.filter(B(s,m)).map(t=>`    ${t.type.trimStart()} ${t.name.replace(/^_/,"z_")} ${t.isId||s.primaryKey?.fields?.includes(t.name)?E:""}${t.isRequired?"":y}`).join(`
`)}
    }
  `).join(`

`),f="";for(let s of d)for(let t of s.fields){let M=t.kind==="enum";if(M&&(i||a))continue;let F=`${M?"enum:":""}${t.name}`,D=`"${s.dbName||s.name}"`,u=`"${d.find(r=>r.name===t.type)?.dbName||t.type}"`;if(t.relationFromFields&&t.relationFromFields.length>0||M){let r="||";t.isList?r="}o":t.isRequired||(r="|o");let e=d.find(h=>h.name===u),c=e?.fields.find(({relationName:h})=>h===t.relationName),b=r;c?.isList?r="o{":c?.isRequired||(r="o|"),f+=`    ${D} ${r}--${b} ${e?.dbName||u} : "${F}"
`}else if(d.find(r=>r.name===t.type||r.dbName===t.type)&&t.relationFromFields?.length===0){let r=d.find(e=>e.name===t.type||e.dbName===t.type);if(r){let e=d.indexOf(s),c=d.indexOf(r);e<c&&(f+=`    ${D} o{--}o ${u} : ""
`)}}else if(t.kind==="object"){let r=o.types.find(e=>e.name.replace(/^_/,"z_").replace(/\s/g,""));if(console.log(u,r),r){let e="||";t.isList?e="}o":t.isRequired||(e="|o");let c=r?.fields.find(({relationName:h})=>h===t.relationName),b=e;c?.isList?e="o{":c?.isRequired||(e="o|"),f+=`    ${D} ${e}--${b} ${r.dbName||u} : "${F}"
`}}}return`${$}
${S}
${w}
${f}`}var B=(o,n)=>i=>n?i.kind!=="object":i.kind!=="object"&&!o.fields.find(({relationFromFields:a})=>a?.includes(i.name)),U=(o,n)=>{let i=n?.split(`
`).filter(a=>a.includes("@map")||a.includes("model ")).map(a=>a.trim());return o.map(a=>({...a,fields:a.fields.map(m=>{let g="None",$=i.filter(d=>(g==="Match"&&d.includes("model ")&&(g="End"),g==="None"&&d.includes(`model ${a.name} `)&&(g="Match"),g==="Match")).find(d=>d.includes(`${m.name} `)&&d.includes("@map"));if($){let S=new RegExp(/@map\(\"(.*?)\"\)/,"g").exec($);if(S?.[1]){let E=S[1].replace(/^_/,"z_").replace(/\s/g,"");m.name=E}}return m})}))},O=async o=>{try{let n=o.generator.output?.value||"./prisma/ERD.svg",i=o.generator.config,a=i.theme??"forest",m=l.resolve(l.join(i.mmdcPath||"node_modules/.bin","mmdc")),g=i.tableOnly==="true",$=i.disableEmoji==="true",d=i.ignoreEnums==="true",S=i.includeRelationFromFields==="true",E=process.env.DISABLE_ERD==="true"||i.disabled==="true",y=i.erdDebug==="true"||!!process.env.ERD_DEBUG;if(y&&(console.log("debug mode enabled"),console.log("config",i)),E)return console.log("ERD generator is disabled");let w=p.default.mkdtempSync(`${N.default.tmpdir()+l.sep}prisma-erd-`);if(!o.dmmf?.datamodel)throw new Error("Datamodel is missing from generator options");let f=JSON.parse(JSON.stringify(o.dmmf.datamodel));if(y&&f){p.default.mkdirSync(l.resolve("prisma/debug"),{recursive:!0});let e=l.resolve("prisma/debug/1-datamodel.json");p.default.writeFileSync(e,JSON.stringify(f,null,2)),console.log(`data model written to ${e}`)}if(f.models=U(f.models,o.datamodel),f.types||(f.types=[]),y&&f.models){let e=l.resolve("prisma/debug/2-datamodel-map-applied.json");p.default.writeFileSync(e,JSON.stringify(f,null,2)),console.log(`applied @map to fields written to ${e}`)}let s=z(f,{tableOnly:g,ignoreEnums:d,includeRelationFromFields:S,disableEmoji:$});if(y&&s){let e=l.resolve("prisma/debug/3-mermaid.mmd");p.default.writeFileSync(e,s),console.log(`mermaid written to ${e}`)}if(!s)throw new Error("failed to construct mermaid instance from dml");if(n.endsWith(".md"))return p.default.writeFileSync(n,`\`\`\`mermaid
${s}\`\`\`
`);let t=l.resolve(l.join(w,"prisma.mmd"));p.default.writeFileSync(t,s);let M={deterministicIds:!0,maxTextSize:9e4,er:{useMaxWidth:!0},theme:a},F=M;if(i?.mermaidConfig){let e=l.resolve(i.mermaidConfig),c=await import((0,L.pathToFileURL)(e).href);y&&console.log("imported mermaid config: ",c),F={...M,...c}}let D=l.resolve(l.join(w,"config.json"));p.default.writeFileSync(D,JSON.stringify(F));let u=i.puppeteerConfig;if(u&&!p.default.existsSync(u))throw new Error(`Puppeteer config file "${u}" does not exist`);if(!u){let e=l.resolve(l.join(w,"puppeteerConfig.json")),c,b={logLevel:y?"warn":"error",executablePath:c};if(N.default.platform()==="darwin"&&N.default.arch()==="arm64")try{let h=C.execSync("which chromium").toString().replace(`
`,"");if(!h)throw new Error("Could not find chromium executable. Refer to https://github.com/keonik/prisma-erd-generator#issues for next steps.");b.executablePath=h,b.args=["--no-sandbox"]}catch(h){console.error(h),console.log(`
Prisma ERD Generator: Unable to find chromium path for you MacOS arm64 machine. Attempting to use the default at ${c}. To learn more visit https://github.com/keonik/prisma-erd-generator#-arm64-users-
`),c="/usr/bin/chromium-browser"}p.default.writeFileSync(e,JSON.stringify(b)),u=e}if(i.mmdcPath){if(!p.default.existsSync(m))throw new Error(`
Mermaid CLI provided path does not exist. 
${m}`)}else if(!p.default.existsSync(m)){let e=C.execSync("find ../.. -name mmdc").toString().split(`
`).filter(c=>c).pop();if(!e||!p.default.existsSync(e))throw new Error(`Expected mermaid CLI at 
${m}

or
${e}
 but this package was not found.`);m=l.resolve(e)}let r=`"${m}" -i "${t}" -o "${n}" -c "${D}" -p "${u}"`;if(y&&r&&console.log("mermaid command: ",r),C.execSync(r),!p.default.existsSync(n))throw new Error(`Issue generating ER Diagram. Expected ${n} to be created`)}catch(n){throw console.error(n),n}};var _=require("fs"),P=process.env.DISABLE_ERD==="true",v;try{v=JSON.parse((0,_.readFileSync)("package.json","utf-8"))}catch(o){console.error(o),v={version:"1.0.0"}}(0,k.generatorHandler)({onManifest:()=>({defaultOutput:P?"N/A":"ERD.svg",prettyName:P?"No ERD":"Entity-relationship-diagram",version:v?.version}),onGenerate:O});
